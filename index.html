<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pearplexed - Interactive Visualizations</title>
    
    <!-- 90s Site Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Sans+MS&family=VT323&display=swap" rel="stylesheet">
    
    <!-- Music Explorer Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.32.0/plotly.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- Styles for the 90s themed site shell --- */
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background-color: #000; /* Default background for the body */
        }
        .font-vt323 {
            font-family: 'VT323', monospace;
        }
        .starry-background {
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            background-color: #000033;
        }
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .flicker-animation {
            animation: flicker 1.5s infinite;
        }
        .pixel-border {
            border: 4px solid;
            border-image-slice: 2;
            border-image-width: 2;
            border-image-repeat: stretch;
            border-image-source: url('data:image/svg+xml;utf8,<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="8px" height="8px" viewBox="0 0 8 8" fill="white"><path d="M0,0 v8 h1 v-7 h6 v-1 z" /><path d="M7,1 v6 h1 v-7 z" /><path d="M1,7 h6 v1 h-7 z" /></svg>');
            border-image-outset: 2;
        }

        /* --- Scoped Styles for the Modern Music Explorer --- */
        #music-explorer-container {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --header-bg-color: #e9ecef;
            --header-text-color: #343a40;
            --controls-bg-color: #ffffff;
            --border-color: #dee2e6;
            --input-bg-color: #fff;
            --input-border-color: #ced4da;
            --input-focus-border-color: #80bdff;
            --input-focus-shadow-color: rgba(0,123,255,.25);
            --table-bg-color: #fff;
            --table-header-bg-color: #f8f9fa;
            --button-bg-color: #007bff;
            --button-hover-bg-color: #0056b3;
            --button-text-color: white;
            --flag-border-color: '#333';
            --details-bg: #f1f3f5;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: row;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        #music-explorer-container[data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --header-bg-color: #1e1e1e;
            --header-text-color: #f5f5f5;
            --controls-bg-color: #1e1e1e;
            --border-color: #444;
            --input-bg-color: #333;
            --input-border-color: #555;
            --input-focus-border-color: #58a6ff;
            --input-focus-shadow-color: rgba(88,166,255,.25);
            --table-bg-color: #2c2c2c;
            --table-header-bg-color: #383838;
            --button-bg-color: #2979ff;
            --button-hover-bg-color: #1c63d8;
            --flag-border-color: '#aaa';
            --details-bg: #2a2a2a;
        }
        #music-explorer-container #controls-sidebar {
            display: flex;
            flex-direction: column;
            flex: 0 0 320px;
            height: 100%;
            border-right: 1px solid var(--border-color);
            background-color: var(--controls-bg-color);
        }
        #music-explorer-container h1 {
            text-align: center;
            color: var(--header-text-color);
            padding: 1rem 0;
            margin: 0;
            background-color: var(--header-bg-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.25rem;
        }
        #music-explorer-container #controls {
            padding: 1rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            transition: background-color 0.3s, border-color 0.3s;
            overflow-y: auto;
        }
        #music-explorer-container .control-group { display: flex; flex-direction: column; gap: 0.25rem; }
        #music-explorer-container .full-width { grid-column: 1 / -1; }
        #music-explorer-container label { font-weight: 500; white-space: nowrap; font-size: 0.9rem; }
        #music-explorer-container select, #music-explorer-container input[type=number], #music-explorer-container input[type=range] {
            width: 100%; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid var(--input-border-color);
            background-color: var(--input-bg-color); color: var(--text-color); box-sizing: border-box;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out, background-color 0.3s, color 0.3s;
        }
        #music-explorer-container select:focus, #music-explorer-container input:focus {
            border-color: var(--input-focus-border-color); outline: 0;
            box-shadow: 0 0 0 0.2rem var(--input-focus-shadow-color);
        }
        #music-explorer-container #main-content-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #music-explorer-container #graph { width: 100%; height: 65vh; }
        #music-explorer-container #tables-container { display: flex; justify-content: flex-start; padding: 1.5rem; gap: 1.5rem; flex-wrap: wrap; align-items: flex-start; border-top: 1px solid var(--border-color); overflow-y: auto; flex-grow: 1; }
        #music-explorer-container table { border-collapse: collapse; background-color: var(--table-bg-color); box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075); border-radius: 0.3rem; overflow: hidden; transition: background-color 0.3s; border: 1px solid var(--border-color); }
        #music-explorer-container th, #music-explorer-container td { border: 1px solid var(--border-color); padding: 0.4rem 0.6rem; text-align: left; vertical-align: middle; font-size: 0.85rem; transition: border-color 0.3s, background-color 0.3s, color 0.3s; }
        #music-explorer-container th { background-color: var(--table-header-bg-color); transition: background-color 0.3s; }
        #music-explorer-container .sortable-header { cursor: pointer; }
        #music-explorer-container .sortable-header:hover { filter: brightness(95%); }
        #music-explorer-container[data-theme="dark"] .sortable-header:hover { filter: brightness(120%); }
        #music-explorer-container button {
            padding: 0.4rem 0.8rem; border: 1px solid transparent; border-radius: 0.25rem;
            background-color: var(--button-bg-color); color: var(--button-text-color); cursor: pointer;
            transition: background-color 0.2s; font-weight: 500; white-space: nowrap; font-size: 0.8rem;
        }
        #music-explorer-container button:hover { background-color: var(--button-hover-bg-color); }
        #music-explorer-container .play-only-btn { background-color: #28a745; }
        #music-explorer-container .play-only-btn:hover { background-color: #218838; }
        #music-explorer-container #resetBtn { background-color: #6c757d; }
        #music-explorer-container #resetBtn:hover { background-color: #5a6268; }
        #music-explorer-container #message-box { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #ffc107; color: #333; padding: 1rem 1.5rem; border-radius: 0.25rem; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000; font-size: 1rem; font-weight: 500; }
        #music-explorer-container .theme-switch-wrapper { display: flex; align-items: center; gap: 10px; }
        #music-explorer-container .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        #music-explorer-container .theme-switch input { display:none; }
        #music-explorer-container .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        #music-explorer-container .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        #music-explorer-container input:checked + .slider { background-color: #2979ff; }
        #music-explorer-container input:checked + .slider:before { transform: translateX(24px); }
        #music-explorer-container #overtone-strength-details { grid-column: 1 / -1; }
        #music-explorer-container #overtone-strength-details summary { padding: 0.5rem 1rem; background-color: var(--details-bg); border: 1px solid var(--border-color); border-radius: 0.25rem; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
        #music-explorer-container #overtone-strength-details summary:hover { filter: brightness(95%); }
        #music-explorer-container #overtone-strength-details[disabled] summary { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; }
        #music-explorer-container[data-theme="dark"] #overtone-strength-details[disabled] summary { background-color: #3a3a3a; color: #888; }
        #music-explorer-container .overtone-panel-content { padding: 1rem; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 0.25rem 0.25rem; }
        #music-explorer-container .overtone-presets { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        #music-explorer-container .preset-btn { font-size: 0.75rem; padding: 0.25rem 0.5rem; background-color: #546e7a; }
        #music-explorer-container .preset-btn:hover { background-color: #455a64; }
        #music-explorer-container .overtone-sliders-container { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        #music-explorer-container .overtone-slider-group { display: flex; flex-direction: column; gap: 0.25rem; }
        #music-explorer-container .overtone-slider-group label { font-size: 0.8rem; }
        #music-explorer-container #reset-overtones-btn, #music-explorer-container #test-overtone-btn { margin-top: 1rem; }
        #music-explorer-container #reset-overtones-btn { background-color: #17a2b8; }
        #music-explorer-container #reset-overtones-btn:hover { background-color: #138496; }
        #music-explorer-container #test-overtone-btn { background-color: #ffc107; color: #212529; }
        #music-explorer-container #test-overtone-btn:hover { background-color: #e0a800; }
        #music-explorer-container .bottom-controls-container { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border-color); margin-top: 1rem; }
    </style>
</head>
<body class="bg-black text-white min-h-screen">

    <div id="app-container">

        <!-- Home Page -->
        <div id="home-page" class="starry-background p-4 md:p-8 min-h-screen">
            <div class="container mx-auto text-center">
                <header class="mb-8">
                    <h1 class="text-5xl md:text-7xl font-vt323 text-yellow-300 flicker-animation" style="text-shadow: 3px 3px 0px #ff00ff, -3px -3px 0px #00ffff;">PEARPLEXED</h1>
                    <p class="text-lg text-cyan-300 mt-2">The most interesting site on the web!</p>
                </header>
                <main>
                    <div class="flex justify-center mb-8">
                         <img src="pear-logo.jpg" alt="Spinning Pear Logo" class="w-24 h-24 animate-spin" style="animation-duration: 3s;">
                    </div>
                    <p class="text-green-400 text-xl mb-6">Click on a topic to explore!</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-8 max-w-2xl mx-auto items-start">
                        <!-- Music Icon with Hover Links -->
                        <div class="group relative text-center">
                             <div class="absolute w-full -top-8 left-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                 <p id="how-it-works-link" class="text-teal-300 hover:text-yellow-300 font-vt333 text-lg cursor-pointer flicker-animation">How it Works</p>
                            </div>
                            <div id="music-icon-nav" class="cursor-pointer transform group-hover:scale-110 transition-transform">
                                <div class="bg-indigo-800 p-4 rounded-lg border-4 border-dashed border-pink-500">
                                     <img src="music-icon.jpg" alt="Music Icon" class="w-full h-auto mx-auto rounded-md">
                                </div>
                                <p class="mt-2 text-xl font-vt323 text-white">Music Dissonance</p>
                            </div>
                        </div>
                        <!-- Standard Model Icon -->
                        <div class="group relative text-center">
                            <div id="physics-icon-nav" class="cursor-pointer transform group-hover:scale-110 transition-transform">
                                <div class="bg-indigo-800 p-4 rounded-lg border-4 border-dashed border-pink-500">
                                    <img src="physics-icon.jpg" alt="Standard Model Icon" class="w-full h-auto mx-auto rounded-md">
                                </div>
                                <p class="mt-2 text-xl font-vt323 text-white">Quantum Physics</p>
                            </div>
                        </div>
    
                        <!-- Placeholder Icons -->
                        <div class="group"> <div class="bg-gray-700 p-4 rounded-lg border-4 border-dashed border-gray-500 opacity-50"> <img src="https://placehold.co/128x128/4B5563/FFFFFF?text=Coming+Soon" alt="Coming Soon" class="w-full h-auto mx-auto rounded-md"> </div> <p class="mt-2 text-xl font-vt323 text-gray-400">???</p> </div>
                        <div class="group"> <div class="bg-gray-700 p-4 rounded-lg border-4 border-dashed border-gray-500 opacity-50"> <img src="https://placehold.co/128x128/4B5563/FFFFFF?text=Coming+Soon" alt="Coming Soon" class="w-full h-auto mx-auto rounded-md"> </div> <p class="mt-2 text-xl font-vt323 text-gray-400">???</p> </div>
                    </div>
                </main>
                <footer class="mt-12">
                    <p class="text-sm text-gray-400">&copy; 1991 Pearplexed. All rights reserved. Not really though.</p>
                </footer>
            </div>
        </div>

        <!-- Music Visualization Page -->
        <div id="music-page" class="hidden min-h-screen bg-gray-900 p-4 md:p-8 relative flex flex-col">
            <div class="container mx-auto flex flex-col flex-grow">
                <header class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h1 class="text-4xl md:text-6xl font-vt323 text-teal-300">Music Dissonance</h1>
                    <div class="flex items-center gap-4">
                        <button id="how-it-works-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg pixel-border transition-colors">How it Works</button>
                        <button id="back-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg pixel-border transition-colors">&lt; Back to Home</button>
                    </div>
                </header>
                <main class="bg-gray-800 rounded-lg shadow-lg border-2 border-blue-500 flex-grow relative">
                    <div id="music-explorer-container"></div>
                </main>
            </div>
        </div>
        <!-- Standard Model Page -->
        <div id="physics-page" class="hidden min-h-screen bg-gray-900 p-4 md:p-8 relative flex flex-col">
            <div class="container mx-auto flex flex-col flex-grow">
                <header class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h1 class="text-4xl md:text-6xl font-vt323 text-teal-300">Quantum Physics</h1>
                    <div class="flex items-center gap-4">
                        <button id="back-from-physics"
                                class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg pixel-border transition-colors">
                            &lt; Back to Home
                        </button>
                    </div>
                </header>

                <main class="bg-gray-800 rounded-lg shadow-lg border-2 border-blue-500 flex-grow relative">
                    <iframe id="standard-model-frame"
                            src="standard-model.html"
                            title="Interactive Standard Model"
                            style="width:100%; height:100vh; border:0; border-radius:0.5rem; background:#111827;">
                    </iframe>
                </main>
            </div>
        </div>
    
        
        <!-- How It Works Page -->
        <div id="how-it-works-page" class="hidden min-h-screen starry-background p-4 md:p-8 flex flex-col">
             <div class="container mx-auto flex flex-col flex-grow">
                <header class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h1 class="text-4xl md:text-6xl font-vt323 text-yellow-300 flicker-animation">How It All Works</h1>
                    <button id="back-to-music-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg pixel-border transition-colors">&lt; Back to Graph</button>
                </header>
                <main class="bg-black bg-opacity-50 p-6 rounded-lg border-2 border-cyan-400 flex-grow text-white">
                    <div id="how-it-works-content">
                        <h2 class="text-3xl font-vt323 text-green-400 mb-4">Coming Soon!</h2>
                        <p>This section will explain the fascinating science and art behind the music graph. Get ready to dive into a rabbit hole of sound!</p>
                    </div>
                </main>
            </div>
        </div>

    </div>

    <script>
        let explorerInitialized = false;

        // A placeholder function that will be overwritten once the explorer is initialized.
        // This prevents errors if a play button is somehow clicked before initialization.
        window.playSoundOnly = function(uniqueToneName) { 
            console.error("playSoundOnly called before explorer initialization.");
        }

        document.addEventListener('DOMContentLoaded', () => {
            const homePage = document.getElementById('home-page');
            const musicPage = document.getElementById('music-page');
            const howItWorksPage = document.getElementById('how-it-works-page');

            const musicIconNav = document.getElementById('music-icon-nav');
            const howItWorksLink = document.getElementById('how-it-works-link');
            const backButton = document.getElementById('back-button');
            const howItWorksButton = document.getElementById('how-it-works-button');
            const backToMusicButton = document.getElementById('back-to-music-button');

            function showPage(pageToShow) {
                [homePage, musicPage, howItWorksPage].forEach(page => {
                    page.classList.add('hidden');
                    page.classList.remove('flex');
                });
                pageToShow.classList.remove('hidden');
                pageToShow.classList.add('flex');
            }

            function showMusicPage() {
                showPage(musicPage);
                if (!explorerInitialized) {
                    initMusicExplorer();
                    explorerInitialized = true;
                }
            }
            
            function showHowItWorksPage() {
                showPage(howItWorksPage);
            }

            if (musicIconNav) musicIconNav.addEventListener('click', showMusicPage);
            if (howItWorksLink) howItWorksLink.addEventListener('click', showHowItWorksPage);
            if (backButton) backButton.addEventListener('click', () => showPage(homePage));
            if (howItWorksButton) howItWorksButton.addEventListener('click', showHowItWorksPage);
            if (backToMusicButton) backToMusicButton.addEventListener('click', showMusicPage);
        });

        function initMusicExplorer() {
            const explorerContainer = document.getElementById('music-explorer-container');
            // This injects the modern UI for the music explorer into the page.
            explorerContainer.innerHTML = `
                <div id="controls-sidebar"><h1>Musical Dissonance Explorer</h1><div id="controls"><div class="control-group"><label for="baseFreq">Base Frequency (Hz)</label><input type="number" id="baseFreq" value="220"></div><div class="control-group"><label for="overtones">Overtones</label><input type="number" id="overtones" min="0" max="12" value="6"></div><div class="control-group"><label for="octaves">Octaves</label><input type="number" id="octaves" min="1" max="4" value="1"></div><div class="control-group"><label for="equation">Dissonance Model</label><select id="equation"><option value="sethares">Sethares</option><option value="dillon">Giorgio Dillon</option></select></div><div class="control-group"><label for="instrument">Instrument Timbre</label><select id="instrument"><option value="sine">Sine</option><option value="square">Square</option><option value="saw">Saw</option><option value="string" selected>String (Harmonic)</option><option value="piano">Piano (Harmonic)</option><option value="stretched_slendro">Slendro (Stretched 1.96)</option><option value="saron_sethares">Saron (Sethares)</option><option value="bonang_sethares">Bonang (Sethares)</option><option value="custom">Custom</option></select></div><div class="control-group"><label for="tones">Tones</label><select id="tones"><option value="2">2 Tones (Dyads)</option><option value="3" selected>3 Tones (Triads)</option><option value="4">4 Tones (Tetrads)</option></select></div><div class="control-group full-width"><label for="tuningSystem">Tuning System</label><select id="tuningSystem"></select></div><div class="full-width" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; align-items: end;"><div class="control-group" id="chart-type-group" style="display: none;"><label for="chartType">Chart Type</label><select id="chartType"></select></div><div class="control-group" id="bubble-size-group" style="display: none;"><label for="bubbleSize">Scaling Factor</label><input type="range" id="bubbleSize" min="5" max="50" step="1" value="25"></div></div><div class="full-width" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; align-items: center;"><div class="control-group"><label for="volume">Volume</label><input type="range" id="volume" min="0" max="1" step="0.01" value="0.2"></div><div style="display: flex; justify-content: center;"><label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input type="checkbox" id="invertRoughness" style="width: auto; margin: 0;">Show Consonance</label></div></div><details id="overtone-strength-details"><summary>Overtone Strength</summary><div class="overtone-panel-content"><div class="overtone-presets" id="overtone-presets"></div><div class="overtone-sliders-container" id="overtone-sliders-container"></div><button id="reset-overtones-btn">Reset Overtones</button><button id="test-overtone-btn">Test Tone</button></div></details><div class="bottom-controls-container"><div class="theme-switch-wrapper"><span>Dark Mode</span><label class="theme-switch"><input type="checkbox" id="theme-toggle"><span class="slider"></span></label></div><button id="resetBtn">Reset to Default</button></div></div></div>
                <div id="main-content-wrapper"><div id="graph"></div><div id="tables-container"><table id="dyads-table"><thead><tr><th>Dyad Name</th><th>Ratio</th><th>Piano Notes</th><th>MIDI Notes</th><th class="sortable-header" data-sort-dir="asc">Roughness ⇅</th><th>Sound</th></tr></thead><tbody></tbody></table><table id="triads-table" style="display:none;"><thead><tr><th>Triad Name</th><th>Ratios</th><th>Piano Notes</th><th>MIDI Notes</th><th class="sortable-header" data-sort-dir="asc">Roughness ⇅</th><th>Sound</th></tr></thead><tbody></tbody></table><table id="tetrads-table" style="display:none;"><thead><tr><th>Tetrad Name</th><th>Ratios</th><th>Piano Notes</th><th>MIDI Notes</th><th class="sortable-header" data-sort-dir="asc">Roughness ⇅</th><th>Sound</th></tr></thead><tbody></tbody></table></div></div>
                <div id="message-box"></div>`;
            
            // Cache DOM elements for performance
            const dom = {
                body: document.getElementById('music-explorer-container'), baseFreq: document.getElementById('baseFreq'), overtones: document.getElementById('overtones'), octaves: document.getElementById('octaves'),
                equation: document.getElementById('equation'), instrument: document.getElementById('instrument'), volume: document.getElementById('volume'), tones: document.getElementById('tones'), tuningSystem: document.getElementById('tuningSystem'), chartTypeGroup: document.getElementById('chart-type-group'),
                chartType: document.getElementById('chartType'), invertRoughness: document.getElementById('invertRoughness'), themeToggle: document.getElementById('theme-toggle'), resetBtn: document.getElementById('resetBtn'), graph: document.getElementById('graph'), messageBox: document.getElementById('message-box'),
                dyadsTable: document.getElementById('dyads-table'), triadsTable: document.getElementById('triads-table'), tetradsTable: document.getElementById('tetrads-table'), dyadsTableBody: document.querySelector('#dyads-table tbody'), triadsTableBody: document.querySelector('#triads-table tbody'), tetradsTableBody: document.querySelector('#tetrads-table tbody'),
                overtoneStrengthDetails: document.getElementById('overtone-strength-details'), overtoneSlidersContainer: document.getElementById('overtone-sliders-container'), overtonePresetsContainer: document.getElementById('overtone-presets'), resetOvertonesBtn: document.getElementById('reset-overtones-btn'),
                testOvertoneBtn: document.getElementById('test-overtone-btn'), bubbleSizeGroup: document.getElementById('bubble-size-group'), bubbleSize: document.getElementById('bubbleSize'),
            };
            let audioCtx; let activeOscillators = []; let activeFlagTimeout = null; let overtoneAmplitudes = [];
            const timbres = {
                'sine':    { name: 'Sine', amp: k => (k === 0 ? 1 : 0), osc: 'sine', partialFn: k => (k === 0 ? 1 : null) }, 'square':  { name: 'Square', amp: k => ((k + 1) % 2 === 1 ? 1 / (k + 1) : 0), osc: 'square', partialFn: k => k + 1 }, 'saw':     { name: 'Saw', amp: k => 1 / (k + 1), osc: 'sawtooth', partialFn: k => k + 1 }, 'string':  { name: 'String (Harmonic)', amp: k => 1 / (k + 1), osc: 'triangle', partialFn: k => k + 1 }, 'piano':   { name: 'Piano (Harmonic)', amp: k => Math.exp(-0.003 * (k+1)**2), osc: 'triangle', partialFn: k => k + 1 }, 'stretched_slendro': { name: 'Slendro (Stretched 1.96)', amp: k => 1 / (k + 1), osc: 'triangle', partialFn: k => (k + 1)**Math.log2(1.96) }, 'saron_sethares': { name: 'Saron (Sethares)', amp: k => 1 / Math.sqrt(k + 1), osc: 'sawtooth', partialFn: k => { const ratios = [1, 2.76, 4.8, 8.4]; return ratios[k] || null; }}, 'bonang_sethares': { name: 'Bonang (Sethares)', amp: k => 1 / (k + 1), osc: 'square', partialFn: k => { const ratios = [1, 2.6, 3.9, 5.2]; return ratios[k] || null; }}, 'custom':  { name: 'Custom', amp: k => (k === 0) ? 1 : (overtoneAmplitudes[k - 1] || 0), osc: 'triangle', partialFn: k => currentPartialFn(k) },
            };
            function getAmpFunction(type) { return timbres[type]?.amp || timbres['string'].amp; }
            function getOscillatorType(type) { return timbres[type]?.osc || timbres['string'].osc; }
            function getPartialFunction(type) { return timbres[type]?.partialFn || (k => k + 1); }
            let currentPartialFn = getPartialFunction('string'); let currentDyadData = []; let currentTriadData = []; let currentTetradData = []; let currentAllTones = {};
            const DISSONANCE_COLORSCALE = [[0, '#1e3a8a'], [0.1, '#3b82f6'], [0.2, '#60a5fa'], [0.3, '#93c5fd'], [0.4, '#dbeafe'], [0.5, '#f3f4f6'], [0.6, '#fed7aa'], [0.7, '#fdba74'], [0.8, '#f97316'], [0.9, '#ea580c'], [1, '#dc2626']];
            function pairRoughness(f1, a1, f2, a2) { if (a1 === 0 || a2 === 0) return 0; const minFreq = Math.min(f1, f2); const freqDiff = Math.abs(f2 - f1); const a = 3.5, b = 5.75, d_star = 0.24, s1 = 0.021, s2 = 19; const s = d_star / (s1 * minFreq + s2); const ampProduct = a1 * a2; return ampProduct * (Math.exp(-a * s * freqDiff) - Math.exp(-b * s * freqDiff)); }
            function getFullSpectrum(freqs, overtoneCount, ampFunction, partialFn) { const fullSpectrum = []; freqs.forEach(f => { for (let k = 0; k <= overtoneCount; k++) { const ratio = partialFn(k); if (ratio === null || typeof ratio === 'undefined') continue; const amp = ampFunction(k); if (amp > 0) { fullSpectrum.push({ freq: f * ratio, amp: amp }); } } }); return fullSpectrum; }
            function calculateDissonance(modelFn, freqs, overtoneCount, ampFunction, partialFn) { const spectrum = getFullSpectrum(freqs, overtoneCount, ampFunction, partialFn); let roughnessSum = 0; for (let i = 0; i < spectrum.length; i++) { for (let j = i + 1; j < spectrum.length; j++) { const r = pairRoughness(spectrum[i].freq, spectrum[i].amp, spectrum[j].freq, spectrum[j].amp); if (modelFn === dillonModel) { roughnessSum += r ** 6; } else { roughnessSum += r; } } } return modelFn === dillonModel ? roughnessSum ** (1 / 6) : roughnessSum; }
            const setharesModel = (freqs, overtones, amp, partialFn) => calculateDissonance(setharesModel, freqs, overtones, amp, partialFn); const dillonModel = (freqs, overtones, amp, partialFn) => calculateDissonance(dillonModel, freqs, overtones, amp, partialFn);
            const overtonePresets = { 'Mellow': [0.8, 0.6, 0.4, 0.2, 0.1, 0.05, 0.02, 0.01, 0, 0, 0, 0], 'Bright': [1.2, 1.3, 1.4, 1.3, 1.2, 1.1, 1.0, 0.9, 0.8, 0.7, 0.6, 0.5], 'Hollow': [0, 1.2, 0, 1.0, 0, 0.8, 0, 0.6, 0, 0.4, 0, 0.2], 'Trumpet': [1.2, 1.5, 1.3, 1.0, 0.8, 0.6, 0.4, 0.2, 0.1, 0.05, 0, 0], 'Clarinet': [0.1, 1.4, 0.2, 1.2, 0.3, 1.0, 0.4, 0.8, 0.5, 0.6, 0.3, 0.1] };
            function initAudio() { if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) { console.error("Web Audio API not supported."); showMessage("Audio not supported."); return; } } if (audioCtx.state === 'suspended') { audioCtx.resume(); } }
            function stopAudio() { if (!audioCtx) return; activeOscillators.forEach(osc => { try { const gainNode = osc.gainNode; gainNode.gain.cancelScheduledValues(audioCtx.currentTime); gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.05); osc.stop(audioCtx.currentTime + 0.05); } catch (e) { /* Ignore */ } }); activeOscillators = []; }
            function playFrequencies(freqs, duration = 0.5) { initAudio(); if (!audioCtx) return; stopAudio(); const settings = getSettings(); const ampFunction = getAmpFunction(settings.instrument); const oscType = getOscillatorType(settings.instrument); const partialFn = getPartialFunction(settings.instrument); const spectrum = getFullSpectrum(freqs, settings.overtones, ampFunction, partialFn); spectrum.forEach(partial => { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.gainNode = gain; osc.type = oscType; osc.frequency.setValueAtTime(partial.freq, audioCtx.currentTime); gain.gain.setValueAtTime(partial.amp * settings.volume, audioCtx.currentTime); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(audioCtx.currentTime); if (duration && isFinite(duration)) { osc.stop(audioCtx.currentTime + duration); } activeOscillators.push(osc); }); }
            const TUNING_SYSTEMS = { 'Western': { pythagorean: { name: 'Pythagorean', cents: [0, 90.22, 203.91, 294.13, 407.82, 498.04, 588.27, 701.96, 792.18, 905.87, 996.09, 1109.78], wolf: 678.5 }, just: { name: 'Just Intonation', cents: [0, 111.73, 203.91, 315.64, 386.31, 498.04, 590.22, 701.96, 813.69, 884.36, 1017.60, 1088.27] }, meantone_1_4: { name: 'Meantone (1/4)', cents: [0, 76.05, 193.16, 310.26, 386.31, 503.42, 579.47, 696.58, 772.63, 889.74, 1006.84, 1082.89], wolf: 737.64 }, meantone_1_3: { name: 'Meantone (1/3)', cents: [0, 62.57, 193.16, 323.74, 386.31, 516.89, 579.47, 696.58, 759.15, 890.31, 952.88, 1083.46], wolf: 743.16 }, werckmeister: { name: 'Werckmeister III', cents: [0, 90.22, 192.18, 294.13, 390.22, 498.04, 588.27, 696.09, 792.18, 888.27, 996.09, 1092.18] }, }, 'Equal Temperament': { equal_12: { name: '12-TET (Equal Temperament)', cents: [0, 100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1100] }, equal_5: { name: '5-TET', cents: [0, 240, 480, 720, 960] }, equal_7: { name: '7-TET', cents: [0, 171.43, 342.86, 514.29, 685.71, 857.14, 1028.57] }, equal_19: { name: '19-TET', cents: [0, 63.16, 126.32, 189.47, 252.63, 315.79, 378.95, 442.11, 505.26, 568.42, 631.58, 694.74, 757.89, 821.05, 884.21, 947.37, 1010.53, 1073.68, 1136.84] }, equal_31: { name: '31-TET', cents: Array.from({length: 31}, (_, i) => i * 38.71) }, equal_53: { name: '53-TET', cents: Array.from({length: 53}, (_, i) => i * 22.64) }, }, 'Gamelan (from Sethares)': { slendro_swastigitha: { name: 'Slendro (Swastigitha)', cents: [0, 241, 482, 727, 969, 1208] }, pelog_swastigitha: { name: 'Pelog (Swastigitha)', cents: [0, 119, 274, 556, 675, 783, 955, 1199] }, slendro_kyai: { name: 'Slendro (Kyai Kaduk Manis)', cents: [0, 241, 480, 722, 961, 1201] }, pelog_kyai: { name: 'Pelog (Kyai Kaduk Manis)', cents: [0, 157, 310, 576, 686, 812, 995, 1212] }, } };
            const DYAD_DEFS = [
    { name: 'Pythagorean Comma', fixedCents: 23.46 }, 
    { name: 'Minor 2nd', step: 1 }, 
    { name: 'Major 2nd', step: 2 }, 
    { name: 'Minor 3rd', step: 3 }, 
    { name: 'Major 3rd', step: 4 }, 
    { name: 'Perfect 4th', step: 5 }, 
    { name: 'Tritone', step: 6 }, 
    { name: 'Perfect 5th', step: 7 }, 
    { name: 'Minor 6th', step: 8 }, 
    { name: 'Major 6th', step: 9 }, 
    { name: 'Minor 7th', step: 10 }, 
    { name: 'Major 7th', step: 11 }, 
    { name: 'Wolf Interval', step: 'wolf' },
    { name: 'Minor 9th', step: 13 },
    { name: 'Major 9th', step: 14 },
    { name: 'Augmented 9th', step: 15 },
    { name: 'Major 10th', step: 16 },
    { name: 'Perfect 11th', step: 17 },
    { name: 'Augmented 11th', step: 18 },
    { name: 'Perfect 12th', step: 19 },
    { name: 'Minor 13th', step: 20 },
    { name: 'Major 13th', step: 21 },
    { name: 'Minor 14th', step: 22 },
    { name: 'Major 14th', step: 23 },
    { name: 'Double Octave', step: 24 },
];
const TRIAD_DEFS = [
    // Secundal
    { name: 'Major Trichord', steps: [0, 2, 4] },
    { name: 'Minor Trichord', steps: [0, 2, 3] },
    { name: 'Phrygian Trichord', steps: [0, 1, 3] },
    // Tertial
    { name: 'Major Triad', steps: [0, 4, 7] },
    { name: 'Minor Triad', steps: [0, 3, 7] },
    { name: 'Diminished Triad', steps: [0, 3, 6] },
    // Quartal
    { name: 'sus4', steps: [0, 5, 7] },
    { name: 'sus#4', steps: [0, 6, 7] },
    { name: '°sus4', steps: [0, 5, 6] },
    // Quintal
    { name: 'Quintal Triad', steps: [0, 7, 14] },
    // 7 no 3
    { name: 'Major 7th (no 3rd)', steps: [0, 7, 11] },
    { name: 'Dominant 7th (no 3rd)', steps: [0, 7, 10] },
    { name: 'Minor 7th b5 (no 3rd)', steps: [0, 6, 10] },
    // 7 no 5
    { name: 'Major 7th (no 5th)', steps: [0, 4, 11] },
    { name: 'min/maj7 (no 5th)', steps: [0, 3, 11] },
    { name: 'Dominant 7th (no 5th)', steps: [0, 4, 10] },
    { name: 'Minor 7th (no 5th)', steps: [0, 3, 10] },
    { name: 'Maj(#4) (no 5th)', steps: [0, 4, 6] },
    { name: 'Maj add4 (no 5th)', steps: [0, 4, 5] },
    { name: 'Maj add(b3) (no 5th)', steps: [0, 3, 4] },
    { name: 'min add4 (no 5th)', steps: [0, 3, 5] },
    // Nondiatonic & Clusters
    { name: 'Chromatic Cluster', steps: [0, 1, 2] },
    { name: 'Augmented Triad', steps: [0, 4, 8] },
    { name: 'Phrygian Major', steps: [0, 1, 4] },
    // Inversions
    { name: 'vi (1st inv)', steps: [0, 4, 9] },
    { name: 'VI (1st inv)', steps: [0, 3, 8] },
    { name: 'iv (2nd inv)', steps: [0, 5, 8] },
    { name: 'IV (2nd inv)', steps: [0, 5, 9] },
    // --- Existing Added Chords ---
    { name: 'sus2', steps: [0, 2, 7] },
    { name: 'Minor add6', steps: [0, 3, 9] },
    { name: 'Major add6 (no 3rd)', steps: [0, 7, 9] },
    { name: 'Gsus2 (1st inv)', steps: [0, 5, 10] },
    { name: 'B♭Maj7/A (no 5th)', steps: [0, 1, 5] },
    { name: 'Dadd9/A (no 3rd)', steps: [0, 2, 5] },
    { name: 'G#m/A (no root)', steps: [0, 2, 6] },
    { name: 'G7/A (no root, no 5th)', steps: [0, 2, 8] },
    { name: 'D6/A', steps: [0, 2, 9] },
    { name: 'Lydian Quartal', steps: [0, 5, 11] },
    { name: 'Dissonant Cluster', steps: [0, 6, 8] },
    { name: 'D# dim (1st inv)', steps: [0, 6, 9] },
    { name: 'AMaj7#11 (shell)', steps: [0, 6, 11] },
    { name: 'FMaj7/A (no 3rd)', steps: [0, 7, 8] },
    { name: 'sus2 (no 5th)', steps: [0, 2, 12] },
    { name: 'Minor (no 5th)', steps: [0, 3, 12] },
    { name: 'Major (no 5th)', steps: [0, 4, 12] },
    { name: 'Quartal Octave Frame', steps: [0, 5, 12] },
    { name: 'Power Chord (doubled root)', steps: [0, 7, 12] },
    { name: 'Minor add9 (no 5th)', steps: [0, 3, 14] },
    { name: 'Major add9 (no 5th)', steps: [0, 4, 14] },
    { name: 'Tritone (doubled root)', steps: [0, 6, 12] },
    { name: 'Maj9 (no 3rd, no 5th)', steps: [0, 2, 11] },
    { name: 'Dom9 (no 3rd, no 5th)', steps: [0, 2, 10] },
    { name: 'm6/M7 Cluster', steps: [0, 8, 11] },
    { name: 'Ab/C (no 5th)', steps: [0, 8, 12] },
    { name: 'Am/C (no 5th)', steps: [0, 9, 12] },
    { name: 'M6/M7 Cluster', steps: [0, 9, 11] },
    { name: 'Cm7(b13) (no 5th)', steps: [0, 8, 10] },
    { name: 'b2/TT Cluster', steps: [0, 1, 6] },
    { name: 'sus(b2)', steps: [0, 1, 7] },
    { name: 'Dbmaj7/C', steps: [0, 1, 8] },
    { name: 'b2/M6 Cluster', steps: [0, 1, 9] },
    { name: 'C7(b9) (no 3rd)', steps: [0, 1, 10] },
    { name: 'b2/M7 Cluster', steps: [0, 1, 11] },
    { name: 'Minor 2nd (doubled root)', steps: [0, 1, 12] },
    { name: 'm6/M6 Cluster', steps: [0, 8, 9] },
    { name: 'Bb/C (sus2)', steps: [0, 10, 12] },
    { name: 'm7/M7 Cluster', steps: [0, 10, 11] },
    { name: 'C13 (no 3rd, no 5th)', steps: [0, 9, 10] },
    { name: 'Major 7th (double root)', steps: [0, 11, 12] },
    // --- Wide Voicings & Extended Shells (NEW) ---
    { name: 'Major Triad (Spread)', steps: [0, 4, 19] },
    { name: 'Major 2nd Inv (Spread)', steps: [0, 7, 16] },
    { name: 'Minor Triad (Spread)', steps: [0, 3, 19] },
    { name: 'Minor 2nd Inv (Spread)', steps: [0, 7, 15] },
    { name: 'sus2 Triad (Spread)', steps: [0, 2, 19] },
    { name: 'sus4 Triad (Spread)', steps: [0, 5, 19] },
    { name: 'sus4 2nd Inv (Spread)', steps: [0, 7, 17] },
    { name: 'Diminished Triad (Spread)', steps: [0, 3, 18] },
    { name: 'Diminished 2nd Inv (Spread)', steps: [0, 6, 15] },
    { name: 'Augmented Triad (Spread)', steps: [0, 4, 20] },
    { name: 'Augmented 2nd Inv (Spread)', steps: [0, 8, 16] },
    { name: 'Dominant 7(b9) shell', steps: [0, 4, 13] },
    { name: 'Dominant 7(#9) shell', steps: [0, 4, 15] },
    { name: 'Major 9 shell (R,7,9)', steps: [0, 11, 14] },
    { name: 'Dominant 9 shell (R,m7,9)', steps: [0, 10, 14] },
    { name: 'Dominant 11 shell (R,m7,11)', steps: [0, 10, 17] },
    { name: 'Lydian shell (R,3,#11)', steps: [0, 4, 18] },
    { name: 'Major 13 shell (R,3,13)', steps: [0, 4, 21] },
    { name: 'Minor 13 shell (R,m3,13)', steps: [0, 3, 21] },
    { name: 'Dominant 13 shell (R,m7,13)', steps: [0, 10, 21] },
    { name: 'Octave & Minor 9th', steps: [0, 12, 13] },
    { name: 'Octave & Major 9th', steps: [0, 12, 14] },
    { name: 'Octave & Major 10th', steps: [0, 12, 16] },
    { name: 'Octave & Perfect 12th', steps: [0, 12, 19] },
    { name: 'Fifth & Double Octave', steps: [0, 7, 24] },
    { name: 'Fourth & Double Octave', steps: [0, 5, 24] },
    { name: 'Major Third & Double Octave', steps: [0, 4, 24] },
    { name: 'Minor Third & Double Octave', steps: [0, 3, 24] },
    { name: 'Major Second & Double Octave', steps: [0, 2, 24] },
    { name: 'Minor 7th & Double Octave', steps: [0, 10, 24]},
    { name: 'Major 7th & Double Octave', steps: [0, 11, 24]},
    { name: 'Octave and a half', steps: [0, 12, 18]},
    { name: 'Wide Minor 7th', steps: [0, 10, 19]},
    { name: 'Wide Major 7th', steps: [0, 11, 19]},
    { name: 'Dreamy Fourth', steps: [0, 5, 16]},
    { name: 'Open Tritone', steps: [0, 6, 19]},
    { name: 'Lydian Quintal', steps: [0, 7, 18]},
    { name: 'Quartal 9th', steps: [0, 5, 14]},
    { name: 'Major 7th & 11th', steps: [0, 11, 17]},
    { name: '6/9 shell', steps: [0, 9, 14] },
    { name: 'Lydian add9 shell', steps: [0, 6, 16] },
    { name: 'Major 9 (Spread shell)', steps: [0, 2, 16] },
];
const TETRAD_DEFS = [
    // --- Basic Triads + Octave ---
    { name: 'Major Triad + Octave', steps: [0, 4, 7, 12] },
    { name: 'Minor Triad + Octave', steps: [0, 3, 7, 12] },

    // --- Core 7th Chords (Root Position) ---
    { name: 'Major 7th', steps: [0, 4, 7, 11] },
    { name: 'Dominant 7th', steps: [0, 4, 7, 10] },
    { name: 'Minor 7th', steps: [0, 3, 7, 10] },
    { name: 'Minor-Major 7th', steps: [0, 3, 7, 11] },
    { name: 'Half-Diminished 7th', steps: [0, 3, 6, 10] },
    { name: 'Diminished 7th', steps: [0, 3, 6, 9] },
    { name: 'Augmented 7th', steps: [0, 4, 8, 10] },
    { name: 'Augmented-Major 7th', steps: [0, 4, 8, 11] },

    // --- 7th Chord Inversions ---
    { name: 'Major 7th (1st inv)', steps: [0, 3, 7, 8] },
    { name: 'Major 7th (2nd inv)', steps: [0, 4, 5, 9] },
    { name: 'Major 7th (3rd inv)', steps: [0, 1, 5, 8] },
    { name: 'Dominant 7th (1st inv)', steps: [0, 3, 6, 8] },
    { name: 'Dominant 7th (2nd inv)', steps: [0, 3, 7, 9] },
    { name: 'Dominant 7th (3rd inv)', steps: [0, 2, 6, 9] },
    { name: 'Minor 7th (1st inv)', steps: [0, 4, 7, 9] },
    { name: 'Minor 7th (2nd inv)', steps: [0, 3, 5, 8] },
    { name: 'Minor 7th (3rd inv)', steps: [0, 2, 5, 9] },
    { name: 'Half-Diminished 7th (1st inv)', steps: [0, 3, 7, 9] },
    { name: 'Half-Diminished 7th (2nd inv)', steps: [0, 4, 6, 9] },
    { name: 'Half-Diminished 7th (3rd inv)', steps: [0, 2, 5, 8] },
    { name: 'Minor-Major 7th (1st inv)', steps: [0, 4, 8, 9] },
    { name: 'Minor-Major 7th (2nd inv)', steps: [0, 4, 5, 8] },
    { name: 'Minor-Major 7th (3rd inv)', steps: [0, 1, 4, 8] },

    // --- 6th Chords ---
    { name: 'Major 6th', steps: [0, 4, 7, 9] },
    { name: 'Minor 6th', steps: [0, 3, 7, 9] },
    { name: 'Major 6th(b5)', steps: [0, 4, 6, 9] },

    // --- Suspended & Added Note Chords ---
    { name: 'Maj add2', steps: [0, 2, 4, 7] },
    { name: 'min add2', steps: [0, 2, 3, 7] },
    { name: 'Maj add4', steps: [0, 4, 5, 7] },
    { name: 'min add4', steps: [0, 3, 5, 7] },
    { name: 'Dominant 7th sus4', steps: [0, 5, 7, 10] },
    { name: 'Major 7th sus4', steps: [0, 5, 7, 11] },
    { name: 'Dominant 7th sus2', steps: [0, 2, 7, 10] },
    { name: 'Major 7th sus2', steps: [0, 2, 7, 11] },
    { name: '7sus4(b9) (no 5th)', steps: [0, 1, 5, 10] },
    { name: '13sus4 (shell)', steps: [0, 5, 9, 10] },

    // --- 9th Chords (4-note voicings) ---
    { name: 'Major 9th (no 5th)', steps: [0, 4, 11, 14] },
    { name: 'Dominant 9th (no 5th)', steps: [0, 4, 10, 14] },
    { name: 'Minor 9th (no 5th)', steps: [0, 3, 10, 14] },
    { name: 'Minor-Major 9th (no 5th)', steps: [0, 3, 11, 14] },
    { name: 'Major 6/9 (no 5th)', steps: [0, 4, 9, 14] },
    { name: 'Minor 6/9 (no 5th)', steps: [0, 3, 9, 14] },

    // --- Altered Dominant & Extended Chords (4-note voicings) ---
    { name: 'Dominant 7th (b9) (no 5th)', steps: [0, 4, 10, 13] },
    { name: 'Hendrix Chord (7#9)', steps: [0, 4, 10, 15] },
    { name: 'Dominant 7th (b5)', steps: [0, 4, 6, 10] },
    { name: 'Dominant 7th (#11) (no 5th)', steps: [0, 4, 10, 18] },
    { name: 'Major 7th (b5)', steps: [0, 4, 6, 11] },
    { name: 'Major 7th (#11) (no 5th)', steps: [0, 4, 11, 18] },
    { name: 'Dominant 13th (shell)', steps: [0, 4, 10, 21] },
    { name: 'Minor 13th (shell)', steps: [0, 3, 10, 21] },
    { name: 'Altered Dominant (7b9b13)', steps: [0, 4, 10, 20] },

    // --- Diatonic & Modal Chords (from Major Scale) ---
    { name: 'IV Maj7', steps: [0, 5, 9, 12] },
    { name: 'vi min7', steps: [0, 3, 7, 8] },

    // --- Other Named & Quartal Chords ---
    { name: 'Italian Aug 6th', steps: [0, 4, 6, 12] },
    { name: 'French Aug 6th', steps: [0, 2, 4, 6] },
    { name: 'German Aug 6th', steps: [0, 3, 4, 6] },
    { name: 'Dream Chord', steps: [0, 3, 8, 11] },
    { name: 'Elektra Chord', steps: [0, 2, 6, 9] },
    { name: 'Magic Chord (tetrad)', steps: [0, 1, 5, 10] },
    { name: 'So What Chord (Quartal)', steps: [0, 5, 10, 15] },
    { name: 'Mystic Chord (Quartal)', steps: [0, 6, 10, 16] },
    { name: 'Quartal Voicing (P4, P4, P4)', steps: [0, 5, 10, 17] },
    { name: 'Quartal Voicing (P4, Aug4, P4)', steps: [0, 5, 11, 16] },
    { name: 'Whole Tone Fragment', steps: [0, 2, 4, 8] },
    { name: 'Chromatic Cluster', steps: [0, 1, 2, 3] },
    
    // --- Wide Voicings & Extended Shells (NEW) ---
    { name: 'Major add9', steps: [0, 4, 7, 14] },
    { name: 'Minor add9', steps: [0, 3, 7, 14] },
    { name: 'Major 9 (no 3rd)', steps: [0, 7, 11, 14] },
    { name: 'Dominant 9 (no 3rd)', steps: [0, 7, 10, 14] },
    { name: 'Minor 9 (no 3rd)', steps: [0, 7, 10, 15] },
    { name: 'Lydian Chord', steps: [0, 4, 7, 18] },
    { name: '11th (Kenny Barron)', steps: [0, 7, 10, 17] },
    { name: 'Dom7(#11) (no 3rd)', steps: [0, 7, 10, 18] },
    { name: 'Maj7(#11) (no 3rd)', steps: [0, 7, 11, 18] },
    { name: 'Major 13 (no 5th)', steps: [0, 4, 11, 21] },
    { name: 'Dom13 (no 3rd)', steps: [0, 7, 10, 21] },
    { name: 'Maj13 (no 3rd)', steps: [0, 7, 11, 21] },
    { name: 'add9 (R,5,8)', steps: [0, 7, 12, 14] },
    { name: 'Maj7 (Spread 1)', steps: [0, 4, 11, 19] },
    { name: 'Maj7 (Spread 2)', steps: [0, 7, 11, 16] },
    { name: 'm7 (Spread 1)', steps: [0, 3, 10, 19] },
    { name: 'm7 (Spread 2)', steps: [0, 7, 10, 15] },
    { name: 'Dom7 (Spread 1)', steps: [0, 4, 10, 19] },
    { name: 'Dom7 (Spread 2)', steps: [0, 7, 10, 16] },
    { name: 'm7b5 (Spread)', steps: [0, 6, 10, 15] },
    { name: 'dim7 (Spread)', steps: [0, 6, 9, 15] },
    { name: 'Quintal Stack', steps: [0, 7, 14, 21] },
    { name: 'Open Quintal-Quartal', steps: [0, 7, 14, 19] },
    { name: 'Open Quartal-Quintal', steps: [0, 5, 10, 22] },
    { name: 'R,5,8,11 Voicing', steps: [0, 7, 12, 17] },
    { name: 'R,4,8,M7 Voicing', steps: [0, 5, 12, 23] },

    // --- Further Comprehensive Additions (NEW) ---
    { name: 'Maj7 (Drop 2)', steps: [0, 5, 9, 16] },
    { name: 'm7 (Drop 2)', steps: [0, 5, 8, 15] },
    { name: 'Dom7 (Drop 2)', steps: [0, 5, 8, 16] },
    { name: 'm7b5 (Drop 2)', steps: [0, 6, 9, 15] },
    { name: 'Altered Dom (b9,#11)', steps: [0, 10, 13, 18] },
    { name: 'Altered Dom (#9,#11)', steps: [0, 10, 15, 18] },
    { name: 'Altered Dom (#9,b13)', steps: [0, 10, 15, 20] },
    { name: 'Altered Dom (Gb/C)', steps: [0, 6, 10, 13] },
    { name: 'Lydian Quartal 2', steps: [0, 6, 11, 17] },
    { name: 'Quartal Maj7', steps: [0, 5, 10, 16] },
    { name: 'Wide Augmented Maj7', steps: [0, 8, 11, 16] },
    { name: 'R,5,8,10 Voicing', steps: [0, 7, 12, 16] },
    { name: 'R,5,8,b13 Voicing', steps: [0, 7, 12, 20] },
    { name: 'R,3,8,11 Voicing', steps: [0, 4, 12, 17] },
    { name: 'R,5,11,13 Voicing', steps: [0, 7, 17, 21] },
    { name: 'R,3,10,13 Voicing', steps: [0, 4, 16, 21] },
    { name: 'Power Chord + 8va, D8va', steps: [0, 7, 12, 24] },
    { name: 'Major Third + 8va, D8va', steps: [0, 4, 12, 24] },
    { name: 'Fifth + 12th + D8va', steps: [0, 7, 19, 24] },
    { name: 'Octave + 10th + D8va', steps: [0, 12, 16, 24] },
    { name: 'Octave + 12th + D8va', steps: [0, 12, 19, 24] },
];
            const PSEUDO_DYAD_DEFS = [{ name: 'Pseudo Octave', partials: [0, 1] }, { name: 'Pseudo Fifth', partials: [1, 2] }]; const PSEUDO_TRIAD_DEFS = [{ name: 'Pseudo Major Triad', partials: [3, 4, 5] }, { name: 'Pseudo Minor Triad', partials: [9, 11, 14] }]; const PSEUDO_TETRAD_DEFS = [{ name: 'Pseudo Dom 7th', partials: [3, 4, 5, 6] }];
            function centsToRatio(cents) { return 2 ** (cents / 1200); }
            function getTuningByKey(key) { for (const group in TUNING_SYSTEMS) { if (TUNING_SYSTEMS[group][key]) { return TUNING_SYSTEMS[group][key]; } } return null; }
            function getPseudoChords() { const instrumentType = dom.instrument.value; const isHarmonic = ['sine', 'square', 'saw', 'string', 'piano'].includes(instrumentType); if (isHarmonic) return { dyads: [], triads: [], tetrads: [] }; const partialFn = getPartialFunction(instrumentType); const calculatePseudoRatios = (partialIndices) => { const basePartial = partialFn(partialIndices[0]); if (basePartial === null || typeof basePartial === 'undefined') return null; const ratios = partialIndices.map(p_idx => { const p_val = partialFn(p_idx); return (p_val === null || typeof p_val === 'undefined') ? null : p_val / basePartial; }); return ratios.some(r => r === null) ? null : ratios; }; const dyads = PSEUDO_DYAD_DEFS.map(def => { const ratios = calculatePseudoRatios(def.partials); return ratios ? { name: def.name, ratioText: ratios.slice(1).map(r => r.toFixed(3)).join(', '), ratios: ratios } : null; }).filter(Boolean); const triads = PSEUDO_TRIAD_DEFS.map(def => { const ratios = calculatePseudoRatios(def.partials); return ratios ? { name: def.name, ratioText: ratios.slice(1).map(r => r.toFixed(3)).join(', '), ratios: ratios } : null; }).filter(Boolean); const tetrads = PSEUDO_TETRAD_DEFS.map(def => { const ratios = calculatePseudoRatios(def.partials); return ratios ? { name: def.name, ratioText: ratios.slice(1).map(r => r.toFixed(3)).join(', '), ratios: ratios } : null; }).filter(Boolean); return { dyads, triads, tetrads }; }

            function updateTuningData() {
                const tuningKey = dom.tuningSystem.value;
                const tuning = getTuningByKey(tuningKey);
                if (!tuning) return;

                const octavesValue = parseInt(dom.octaves.value, 10);
                const numStepsInOctave = tuning.cents.length;

                currentDyadData = DYAD_DEFS.map(def => {
                    if (typeof def.step === 'number' && def.step > 12 && octavesValue < 2) {
                        return null;
                    }

                    if (def.fixedCents) {
                        const ratio = centsToRatio(def.fixedCents);
                        return { name: def.name, ratioText: ratio.toFixed(3), ratios: [1, ratio] };
                    }
                    if (def.step === 'wolf' && tuning.wolf) {
                        const ratio = centsToRatio(tuning.wolf);
                        return { name: def.name, ratioText: ratio.toFixed(3), ratios: [1, ratio] };
                    }
                    
                    if (typeof def.step === 'number') {
                        const octaves = Math.floor(def.step / numStepsInOctave);
                        const scaleDegree = def.step % numStepsInOctave;
                        const baseCents = tuning.cents[scaleDegree];
                        if (typeof baseCents === 'undefined') return null;
                        
                        const totalCents = baseCents + (octaves * 1200);
                        const ratio = centsToRatio(totalCents);
                        return { name: def.name, ratioText: ratio.toFixed(3), ratios: [1, ratio] };
                    }
                    return null;
                }).filter(item => item !== null);

                if (numStepsInOctave >= 12) {
                    currentDyadData.push({ name: 'Octave', ratioText: '2.000', ratios: [1, 2.0] });
                }

                currentTriadData = TRIAD_DEFS.map(def => {
                    const maxStep = Math.max(...def.steps);
                    if (maxStep > 12 && octavesValue < 2) {
                        return null;
                    }

                    if (!def.steps.every(s => typeof s === 'number') || !tuning || !tuning.cents) return null;
                    
                    const ratios = def.steps.map(step => {
                        const octaves = Math.floor(step / numStepsInOctave);
                        const scaleDegree = step % numStepsInOctave;
                        const baseCents = tuning.cents[scaleDegree];
                        if (typeof baseCents === 'undefined') return null;
                        const totalCents = baseCents + (octaves * 1200);
                        return centsToRatio(totalCents);
                    });

                    if (ratios.some(r => r === null)) return null;
                    return { name: def.name, ratioText: ratios.slice(1).map(r => r.toFixed(3)).join(', '), ratios: ratios };
                }).filter(item => item !== null);

                currentTetradData = TETRAD_DEFS.map(def => {
                    const maxStep = Math.max(...def.steps);
                    if (maxStep > 12 && octavesValue < 2) {
                        return null;
                    }

                    if (!def.steps.every(s => typeof s === 'number') || !tuning || !tuning.cents) return null;

                    const ratios = def.steps.map(step => {
                        const octaves = Math.floor(step / numStepsInOctave);
                        const scaleDegree = step % numStepsInOctave;
                        const baseCents = tuning.cents[scaleDegree];
                        if (typeof baseCents === 'undefined') return null;
                        const totalCents = baseCents + (octaves * 1200);
                        return centsToRatio(totalCents);
                    });
                    
                    if (ratios.some(r => r === null)) return null;
                    return { name: def.name, ratioText: ratios.slice(1).map(r => r.toFixed(3)).join(', '), ratios: ratios };
                }).filter(item => item !== null);
                
                const pseudoChords = getPseudoChords();
                if (pseudoChords.dyads.length > 0) {
                    const pseudoFifth = pseudoChords.dyads.find(d => d.name === 'Pseudo Fifth');
                    if (pseudoFifth) {
                        const p5Index = currentDyadData.findIndex(d => d.name === 'Perfect 5th');
                        if (p5Index > -1) {
                            currentDyadData.splice(p5Index + 1, 0, pseudoFifth);
                        } else {
                            currentDyadData.push(pseudoFifth);
                        }
                    }
                    const pseudoOctave = pseudoChords.dyads.find(d => d.name === 'Pseudo Octave');
                    if (pseudoOctave) {
                        const octIndex = currentDyadData.findIndex(d => d.name === 'Octave');
                        if (octIndex > -1) {
                            currentDyadData.splice(octIndex + 1, 0, pseudoOctave);
                        } else {
                            currentDyadData.push(pseudoOctave);
                        }
                    }
                }
                currentTriadData.push(...pseudoChords.triads);
                currentTetradData.push(...pseudoChords.tetrads);
                
                currentAllTones = [...currentDyadData, ...currentTriadData, ...currentTetradData].reduce((acc, curr) => {
                    const uniqueName = curr.ratios.length > 2 ? `${curr.name} ${curr.ratios.length}-tone` : curr.name;
                    acc[uniqueName] = { ratios: curr.ratios, ratioText: curr.ratioText, originalName: curr.name };
                    return acc;
                }, {});
            }
            function freqToMidi(freq) { return Math.round(69 + 12 * Math.log2(freq / 440)); } function midiToNoteName(midi) { const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B']; const octave = Math.floor(midi / 12) - 1; return noteNames[midi % 12] + octave; }
            function populateTables() { const settings = getSettings(); const model = settings.equation === 'dillon' ? dillonModel : setharesModel; const ampFunction = getAmpFunction(settings.instrument); const partialFn = getPartialFunction(settings.instrument); const baseFreq = +dom.baseFreq.value; const processData = (data, tableBody, isSortable) => { if (!data || data.length === 0) return; let itemsWithDissonance = data.map(item => { const freqs = item.ratios.map(r => r * baseFreq); const roughness = model(freqs, settings.overtones, ampFunction, partialFn); return { ...item, roughness }; }); if (isSortable) { const sortDir = tableBody.closest('table').querySelector('.sortable-header').dataset.sortDir; if (sortDir === 'asc') { itemsWithDissonance.sort((a, b) => a.roughness - b.roughness); } else { itemsWithDissonance.sort((a, b) => b.roughness - a.roughness); } } const allRoughnessValues = itemsWithDissonance.map(item => item.roughness).filter(r => isFinite(r)); const maxRoughness = Math.max(...allRoughnessValues); tableBody.innerHTML = ''; itemsWithDissonance.forEach(item => { const freqs = item.ratios.map(r => r * baseFreq); const normalizedRoughness = maxRoughness > 0 ? item.roughness / maxRoughness : 0; tableBody.innerHTML += createRow(item, freqs, item.roughness, normalizedRoughness); }); }; const createRow = (item, freqs, roughness, normalizedRoughness) => { const midiNotes = freqs.map(freqToMidi); const pianoNotes = midiNotes.map(midiToNoteName); const uniqueName = item.ratios.length > 2 ? `${item.name} ${item.ratios.length}-tone` : item.name; const bgColor = getColorForValue(normalizedRoughness, DISSONANCE_COLORSCALE); const textColor = getContrastColor(bgColor); return `<tr style="background-color: ${bgColor}; color: ${textColor};"><td>${item.name}</td><td>${item.ratioText}</td><td>${pianoNotes.join(', ')}</td><td>${midiNotes.join(', ')}</td><td>${roughness.toFixed(4)}</td><td><button class="play-only-btn" onclick="playSoundOnly('${uniqueName}')" style="color: var(--button-text-color); background-color: var(--button-bg-color);">Play</button></td></tr>`; }; processData(currentDyadData, dom.dyadsTableBody, true); processData(currentTriadData, dom.triadsTableBody, true); processData(currentTetradData, dom.tetradsTableBody, true); }
            function getSettings() { return { baseFreq: +dom.baseFreq.value, overtones: +dom.overtones.value, octaves: +dom.octaves.value, equation: dom.equation.value, instrument: dom.instrument.value, volume: +dom.volume.value, tones: +dom.tones.value, chartType: dom.chartType.value, invert: dom.invertRoughness.checked, theme: dom.body.dataset.theme, bubbleSize: +dom.bubbleSize.value, }; }
            function updateChartTypeOptions() { const tones = +dom.tones.value; const chartTypeSelect = dom.chartType; const currentChartType = chartTypeSelect.value; chartTypeSelect.innerHTML = ''; if (tones === 3) { chartTypeSelect.innerHTML = `<option value="surface">3D Surface</option><option value="heatmap">2D Heatmap</option>`; chartTypeSelect.value = (currentChartType === 'surface' || currentChartType === 'heatmap') ? currentChartType : 'surface'; } else if (tones === 4) { chartTypeSelect.innerHTML = `<option value="scatter">3D Scatter</option><option value="scaled">Scaled View</option>`; chartTypeSelect.value = (currentChartType === 'scatter' || currentChartType === 'scaled') ? currentChartType : 'scatter'; } }
            function generateAndPlot() { const lastCamera = (dom.graph.layout && dom.graph.layout.scene && dom.graph.layout.scene.camera) ? JSON.parse(JSON.stringify(dom.graph.layout.scene.camera)) : null; const settings = getSettings(); const ampFunction = getAmpFunction(settings.instrument); const partialFn = getPartialFunction(settings.instrument); const model = settings.equation === 'dillon' ? dillonModel : setharesModel; dom.dyadsTable.style.display = settings.tones == 2 ? '' : 'none'; dom.triadsTable.style.display = settings.tones == 3 ? '' : 'none'; dom.tetradsTable.style.display = settings.tones == 4 ? '' : 'none'; updateChartTypeOptions(); dom.chartTypeGroup.style.display = settings.tones >= 3 ? '' : 'none'; dom.bubbleSizeGroup.style.display = (settings.tones == 4 && settings.chartType === 'scaled') ? '' : 'none'; if (settings.tones == 4) { plot4Tones(settings, ampFunction, partialFn, model, lastCamera); } else if (settings.tones == 2) { plot2D(settings, ampFunction, partialFn, model); } else { if (settings.chartType === 'heatmap') { plot3DHeatmap(settings, ampFunction, partialFn, model); } else { plot3DSurface(settings, ampFunction, partialFn, model, lastCamera); } } }
            function getPlotlyThemeLayout(theme) { if (theme === 'dark') { return { font: { color: '#e0e0e0' }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', gridcolor: 'rgba(255,255,255,0.3)' }; } return { font: { color: '#212529' }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', gridcolor: 'rgba(0,0,0,0.1)' }; }
            function hexToRgb(hex) { let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null; }
            function rgbStringToRgb(rgbString) { const result = /rgb\((\d+),\s*(\d+),\s*(\d+)\)/.exec(rgbString); return result ? { r: +result[1], g: +result[2], b: +result[3] } : null; }
            function getContrastColor(rgbString) { const rgb = rgbStringToRgb(rgbString); if (!rgb) return '#000000'; const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000; return brightness > 128 ? '#000000' : '#FFFFFF'; }
            function getColorForValue(value, colorscale) { for (let i = 0; i < colorscale.length - 1; i++) { const c1 = colorscale[i], c2 = colorscale[i + 1]; if (value >= c1[0] && value <= c2[0]) { const t = (value - c1[0]) / (c2[0] - c1[0]); const color1 = hexToRgb(c1[1]), color2 = hexToRgb(c2[1]); if (!color1 || !color2) return 'rgb(0,0,0)'; const r = Math.round(color1.r + t * (color2.r - color1.r)); const g = Math.round(color1.g + t * (color2.g - color1.g)); const b = Math.round(color1.b + t * (color2.b - color1.b)); return `rgb(${r},${g},${b})`; } } return colorscale[colorscale.length - 1][1]; }
            function plot2D(settings, ampFunction, partialFn, model) { const pointsPerOctave = 300, minRatio = 0.95; const maxRatio = Math.pow(2, settings.octaves); const totalOctaves = Math.log2(maxRatio) - Math.log2(minRatio); const numPoints = Math.ceil(totalOctaves * pointsPerOctave); const ratios = Array.from({length: numPoints + 1}, (_, i) => Math.pow(2, Math.log2(minRatio) + i * (totalOctaves / numPoints))); const dissonances = ratios.map(r => { return model([settings.baseFreq, settings.baseFreq * r], settings.overtones, ampFunction, partialFn); }); const maxDissonance = Math.max(...dissonances.filter(d => isFinite(d))); const normalizedDissonances = dissonances.map(d => maxDissonance > 0 ? d / maxDissonance : 0); dom.graph.maxDissonance = maxDissonance; const data = []; for (let i = 0; i < ratios.length - 1; i++) { const avgDissonance = (normalizedDissonances[i] + normalizedDissonances[i+1]) / 2; data.push({ x: [ratios[i], ratios[i+1]], y: [normalizedDissonances[i], normalizedDissonances[i+1]], type: 'scatter', mode: 'lines', line: { color: getColorForValue(avgDissonance, DISSONANCE_COLORSCALE), width: 5 }, hoverinfo: 'none' }); } const hoverBgColors = normalizedDissonances.map(d => getColorForValue(d, DISSONANCE_COLORSCALE)); data.push({ x: ratios, y: normalizedDissonances, type: 'scatter', mode: 'markers', hoverinfo: 'x+y', name: 'Dissonance', marker: { opacity: 0 }, hoverlabel: { bgcolor: hoverBgColors, font: { color: hoverBgColors.map(getContrastColor) }, bordercolor: '#000' } }); const dyadPoints = { x: [], y: [], text: [], name: [] }; currentDyadData.forEach(item => { if (item.ratios[1] <= maxRatio) { const dissonance = model([settings.baseFreq, settings.baseFreq * item.ratios[1]], settings.overtones, ampFunction, partialFn); const uniqueName = `${item.name}`; dyadPoints.x.push(item.ratios[1]); dyadPoints.y.push(maxDissonance > 0 ? dissonance / maxDissonance : 0); dyadPoints.text.push(`${item.name}<br>Ratio: ${item.ratioText}`); dyadPoints.name.push(uniqueName); } }); data.push({ x: dyadPoints.x, y: dyadPoints.y, type: 'scatter', mode: 'markers', hoverinfo: 'text', text: dyadPoints.text, customdata: dyadPoints.name, marker: { color: '#ff6600', size: 8, line: { color: 'black', width: 1 } } }); const layout = { ...getPlotlyThemeLayout(settings.theme), title: `Dissonance Curve (${timbres[settings.instrument].name} timbre)`, xaxis: { title: 'Frequency Ratio', type: 'log', range: [Math.log10(minRatio), Math.log10(maxRatio)], tickvals: [1, ...currentDyadData.map(i => i.ratios[1])], ticktext: ['1:1', ...currentDyadData.map(i => i.ratioText)], gridcolor: getPlotlyThemeLayout(settings.theme).gridcolor }, yaxis: { title: settings.invert ? 'Consonance' : 'Roughness', range: [0, 1.05], autorange: settings.invert ? 'reversed' : false, gridcolor: getPlotlyThemeLayout(settings.theme).gridcolor }, margin: { l: 60, r: 30, b: 60, t: 50 }, showlegend: false, annotations: [], shapes: [] }; Plotly.react('graph', data, layout); dom.graph.removeAllListeners('plotly_click'); dom.graph.on('plotly_click', e => { if (e.points[0].data.mode === 'markers') { playFrequencies([settings.baseFreq, settings.baseFreq * e.points[0].x]); } }); }
            function calculate3DData(settings, model, ampFunction, partialFn) { const steps = 80 * settings.octaves; const maxRatio = Math.pow(2, settings.octaves); const ratios = Array.from({ length: steps + 1 }, (_, i) => Math.pow(maxRatio, i / steps)); const x_values = ratios; const y_values = ratios; const z_values_raw = y_values.map(r2 => x_values.map(r1 => model([settings.baseFreq, settings.baseFreq * r1, settings.baseFreq * r2], settings.overtones, ampFunction, partialFn))); const z_flat_finite = z_values_raw.flat().filter(z => isFinite(z)); const maxZ = Math.max(...z_flat_finite); const minZ = Math.min(...z_flat_finite); dom.graph.maxZ = maxZ; dom.graph.minZ = minZ; const z_values = z_values_raw.map(row => row.map(val => maxZ > minZ ? Math.pow((val - minZ) / (maxZ - minZ), 0.7) : 0)); return { x_values, y_values, z_values }; }
            function plot3DSurface(settings, ampFunction, partialFn, model, lastCamera) { const { x_values, y_values, z_values } = calculate3DData(settings, model, ampFunction, partialFn); const maxRatio = Math.pow(2, settings.octaves); const data = [{ x: x_values, y: y_values, z: z_values, type: 'surface', colorscale: DISSONANCE_COLORSCALE, cmin: 0, cmax: 1, showscale: true, colorbar: { title: "Roughness", titleside: "right" }, contours: { z: { show: true, usecolormap: true, highlightcolor: "white", project: { z: true } } }, lighting: { ambient: settings.invert ? 0.8 : 0.4, diffuse: 0.8, fresnel: 0.3, specular: 0.2, roughness: 0.1 }, lightposition: { x: 100, y: 200, z: 2000 }, opacity: 1.0 }]; const triadPoints3D = { x: [], y: [], z: [], text: [], name: [] }; currentTriadData.forEach(c => { if (c.ratios[1] <= maxRatio && c.ratios[2] <= maxRatio) { const raw_z = model([settings.baseFreq, c.ratios[1] * settings.baseFreq, c.ratios[2] * settings.baseFreq], settings.overtones, ampFunction, partialFn); const norm_z = dom.graph.maxZ > dom.graph.minZ ? Math.pow((raw_z - dom.graph.minZ) / (dom.graph.maxZ - dom.graph.minZ), 0.7) : 0; const uniqueName = `${c.name} 3-tone`; triadPoints3D.x.push(c.ratios[1]); triadPoints3D.y.push(c.ratios[2]); triadPoints3D.z.push(norm_z + 0.01); triadPoints3D.text.push(`${c.name}<br>Ratios: ${c.ratioText}`); triadPoints3D.name.push(uniqueName); } }); data.push({ x: triadPoints3D.x, y: triadPoints3D.y, z: triadPoints3D.z, type: 'scatter3d', mode: 'markers', hoverinfo: 'text', text: triadPoints3D.text, customdata: triadPoints3D.name, marker: { color: '#ff6600', size: 5, line: { color: 'black', width: 1 } } }); const layout = { ...getPlotlyThemeLayout(settings.theme), title: `3-Tone Dissonance Surface (${timbres[settings.instrument].name} timbre)`, scene: { xaxis: { title: 'Freq2 Ratio', type: 'log', autorange: true, gridcolor: getPlotlyThemeLayout(settings.theme).gridcolor }, yaxis: { title: 'Freq3 Ratio', type: 'log', autorange: true, gridcolor: getPlotlyThemeLayout(settings.theme).gridcolor }, zaxis: { title: settings.invert ? 'Consonance' : 'Roughness', range: [0, 1.05], autorange: settings.invert ? 'reversed' : false, gridcolor: getPlotlyThemeLayout(settings.theme).gridcolor }, camera: lastCamera || { eye: { x: 1.2, y: 1.2, z: 0.8 }, center: { x: 0, y: 0, z: 0 } }, aspectmode: 'cube', annotations: [] }, margin: { l: 0, r: 0, b: 0, t: 40 }, showlegend: false }; Plotly.react('graph', data, layout); dom.graph.removeAllListeners('plotly_click'); dom.graph.on('plotly_click', e => { playFrequencies([settings.baseFreq, settings.baseFreq * e.points[0].x, settings.baseFreq * e.points[0].y]); }); }
            function plot3DHeatmap(settings, ampFunction, partialFn, model) { const { x_values, y_values, z_values } = calculate3DData(settings, model, ampFunction, partialFn); const maxRatio = Math.pow(2, settings.octaves); const triadPoints = { x: [], y: [], text: [], name: [] }; currentTriadData.forEach(c => { if (c.ratios[1] <= maxRatio && c.ratios[2] <= maxRatio) { const uniqueName = `${c.name} 3-tone`; triadPoints.x.push(c.ratios[1]); triadPoints.y.push(c.ratios[2]); triadPoints.text.push(`${c.name}<br>Ratios: ${c.ratioText}`); triadPoints.name.push(uniqueName); } }); const data = [{ x: x_values, y: y_values, z: z_values, type: 'heatmap', colorscale: DISSONANCE_COLORSCALE, reversescale: settings.invert, cmin: 0, cmax: 1, showscale: true, colorbar: { title: settings.invert ? 'Consonance' : 'Roughness', titleside: "right" }, transpose: true, hoverinfo: 'x+y+z' }, { x: triadPoints.x, y: triadPoints.y, type: 'scatter', mode: 'markers', hoverinfo: 'text', text: triadPoints.text, customdata: triadPoints.name, marker: { color: '#ff6600', size: 10, line: { color: 'black', width: 1 } } }]; const layout = { ...getPlotlyThemeLayout(settings.theme), title: `3-Tone Dissonance Heatmap (${timbres[settings.instrument].name} timbre)`, xaxis: { title: 'Freq2 Ratio', type: 'log', autorange: true, gridcolor: getPlotlyThemeLayout(settings.theme).gridcolor }, yaxis: { title: 'Freq3 Ratio', type: 'log', autorange: true, gridcolor: getPlotlyThemeLayout(settings.theme).gridcolor }, margin: { l: 60, r: 30, b: 60, t: 50 }, showlegend: false, annotations: [], shapes: [] }; Plotly.react('graph', data, layout); dom.graph.removeAllListeners('plotly_click'); dom.graph.on('plotly_click', e => { const point = e.points[0]; const freqs = [settings.baseFreq, settings.baseFreq * point.x, settings.baseFreq * point.y]; playFrequencies(freqs); }); }
            function calculate4DData(settings, model, ampFunction, partialFn) { const steps = 20; const maxRatio = Math.pow(2, settings.octaves); const ratios = Array.from({ length: steps + 1 }, (_, i) => Math.pow(maxRatio, i / steps)); let points = []; for (let i = 0; i < ratios.length; i++) { for (let j = i; j < ratios.length; j++) { for (let k = j; k < ratios.length; k++) { const freqs = [settings.baseFreq, settings.baseFreq * ratios[i], settings.baseFreq * ratios[j], settings.baseFreq * ratios[k]]; const dissonance = model(freqs, settings.overtones, ampFunction, partialFn); points.push({ x: ratios[i], y: ratios[j], z: ratios[k], dissonance }); } } } const dissonances = points.map(p => p.dissonance).filter(d => isFinite(d)); const maxD = Math.max(...dissonances); const minD = Math.min(...dissonances); points.forEach(p => { const normalizedDissonance = maxD > minD ? (p.dissonance - minD) / (maxD - minD) : 0; p.color = normalizedDissonance; p.size = (1 - normalizedDissonance) * settings.bubbleSize + 5; }); return { x: points.map(p => p.x), y: points.map(p => p.y), z: points.map(p => p.z), color: points.map(p => p.color), size: points.map(p => p.size) }; }
            function plot4Tones(settings, ampFunction, partialFn, model, lastCamera) { const { x, y, z, color, size } = calculate4DData(settings, model, ampFunction, partialFn); let trace; if (settings.chartType === 'scaled') { trace = { x: x, y: y, z: z, mode: 'markers', type: 'scatter3d', hoverinfo: 'none', marker: { color: color, size: size, sizemode: 'diameter', colorscale: DISSONANCE_COLORSCALE, reversescale: settings.invert, opacity: 0.6, colorbar: { title: settings.invert ? 'Consonance' : 'Dissonance' } } }; } else { trace = { x: x, y: y, z: z, mode: 'markers', type: 'scatter3d', hoverinfo: 'none', marker: { color: color, colorscale: DISSONANCE_COLORSCALE, reversescale: settings.invert, size: 5, opacity: 0.7, colorbar: { title: settings.invert ? 'Consonance' : 'Dissonance' } } }; } const data = [trace]; const tetradPoints = { x: [], y: [], z: [], text: [], name: [] }; const maxRatio = Math.pow(2, settings.octaves); currentTetradData.forEach(c => { if (c.ratios[1] <= maxRatio && c.ratios[2] <= maxRatio && c.ratios[3] <= maxRatio) { const uniqueName = `${c.name} 4-tone`; tetradPoints.x.push(c.ratios[1]); tetradPoints.y.push(c.ratios[2]); tetradPoints.z.push(c.ratios[3]); tetradPoints.text.push(`${c.name}<br>Ratios: ${c.ratioText}`); tetradPoints.name.push(uniqueName); } }); data.push({ x: tetradPoints.x, y: tetradPoints.y, z: tetradPoints.z, type: 'scatter3d', mode: 'markers', hoverinfo: 'text', text: tetradPoints.text, customdata: tetradPoints.name, marker: { color: '#ff6600', size: 8, line: { color: 'black', width: 2 } } }); const layout = { ...getPlotlyThemeLayout(settings.theme), title: `4-Tone Dissonance Space (${timbres[settings.instrument].name} timbre)`, scene: { xaxis: { title: 'Freq2 Ratio', type: 'log', autorange: true, gridcolor: getPlotlyThemeLayout(settings.theme).gridcolor }, yaxis: { title: 'Freq3 Ratio', type: 'log', autorange: true, gridcolor: getPlotlyThemeLayout(settings.theme).gridcolor }, zaxis: { title: 'Freq4 Ratio', type: 'log', autorange: true, gridcolor: getPlotlyThemeLayout(settings.theme).gridcolor }, camera: lastCamera || { eye: { x: 1.5, y: 1.5, z: 1.5 }, center: { x: 0, y: 0, z: 0 } }, aspectmode: 'cube' }, margin: { l: 0, r: 0, b: 0, t: 40 }, showlegend: false }; Plotly.react('graph', data, layout); dom.graph.removeAllListeners('plotly_click'); dom.graph.on('plotly_click', e => { const point = e.points[0]; playFrequencies([settings.baseFreq, settings.baseFreq * point.x, settings.baseFreq * point.y, settings.baseFreq * point.z]); }); }
            
            window.playSoundOnly = function(uniqueToneName) { const toneData = currentAllTones[uniqueToneName]; if (!toneData) return; const { ratios, ratioText } = toneData; const settings = getSettings(); const freqs = ratios.map(r => r * settings.baseFreq); const duration = 1.5; playFrequencies(freqs, duration); if (activeFlagTimeout) clearTimeout(activeFlagTimeout); const ampFunction = getAmpFunction(settings.instrument); const partialFn = getPartialFunction(settings.instrument); const model = settings.equation === 'dillon' ? dillonModel : setharesModel; let tempTrace; let lastCamera; if (dom.graph.layout && dom.graph.layout.scene) { lastCamera = JSON.parse(JSON.stringify(dom.graph.layout.scene.camera)); } if (ratios.length === 2 && settings.tones == 2) { if (typeof dom.graph.maxDissonance === 'undefined') return; const ratio = ratios[1]; const dissonance = model([settings.baseFreq, settings.baseFreq * ratio], settings.overtones, ampFunction, partialFn); const normalizedDissonance = dom.graph.maxDissonance > 0 ? dissonance / dom.graph.maxDissonance : 0; tempTrace = { x: [ratio], y: [normalizedDissonance], type: 'scatter', mode: 'markers', hoverinfo: 'none', marker: { color: '#ff9900', size: 12, line: { color: 'white', width: 2 } } }; } else if (ratios.length === 3 && settings.tones == 3) { if (settings.chartType === 'heatmap') { tempTrace = { x: [ratios[1]], y: [ratios[2]], type: 'scatter', mode: 'markers', hoverinfo: 'none', marker: { color: '#ff9900', size: 15, line: { color: 'white', width: 2 } } }; } else if (settings.chartType === 'surface') { if (typeof dom.graph.maxZ === 'undefined' || typeof dom.graph.minZ === 'undefined') return; const raw_z = model([settings.baseFreq, ratios[1] * settings.baseFreq, ratios[2] * settings.baseFreq], settings.overtones, ampFunction, partialFn); const norm_z = dom.graph.maxZ > dom.graph.minZ ? Math.pow((raw_z - dom.graph.minZ) / (dom.graph.maxZ - dom.graph.minZ), 0.7) : 0; tempTrace = { x: [ratios[1]], y: [ratios[2]], z: [norm_z + 0.015], type: 'scatter3d', mode: 'markers', hoverinfo: 'none', marker: { color: '#ff9900', size: 8, line: { color: 'white', width: 2 } } }; } } else if (ratios.length === 4 && settings.tones == 4) { tempTrace = { x: [ratios[1]], y: [ratios[2]], z: [ratios[3]], type: 'scatter3d', mode: 'markers', hoverinfo: 'none', marker: { color: '#ff9900', size: 10, line: { color: 'white', width: 2 } } }; } if (tempTrace) { Plotly.addTraces('graph', tempTrace).then(() => { if (lastCamera) { Plotly.relayout('graph', { 'scene.camera': lastCamera }); } }); activeFlagTimeout = setTimeout(() => { const traceCount = dom.graph.data.length; if (traceCount > 1) { Plotly.deleteTraces('graph', traceCount - 1); } }, duration * 1000); } }
            
            function updateOvertoneControls(forceReset = false) {
                const settings = getSettings();
                const oldAmplitudes = [...overtoneAmplitudes];
                dom.overtoneSlidersContainer.innerHTML = '';
                overtoneAmplitudes = [];
                if (settings.instrument === 'sine') {
                    dom.overtoneStrengthDetails.setAttribute('disabled', true);
                    dom.overtoneStrengthDetails.open = false;
                    return;
                }
                dom.overtoneStrengthDetails.removeAttribute('disabled');
                const ampFn = getAmpFunction(settings.instrument);
                for (let i = 1; i <= settings.overtones; i++) {
                    const overtoneIndex = i;
                    const partialIndex = i - 1;
                    let ampValue;
                    if (forceReset || settings.instrument !== 'custom') {
                        ampValue = ampFn(overtoneIndex);
                    } else {
                        if (oldAmplitudes[partialIndex] !== undefined) {
                            ampValue = oldAmplitudes[partialIndex];
                        } else {
                            ampValue = 0.75;
                        }
                    }
                    overtoneAmplitudes[partialIndex] = ampValue;
                    const group = document.createElement('div');
                    group.className = 'overtone-slider-group';
                    const label = document.createElement('label');
                    label.setAttribute('for', `overtone-${overtoneIndex}`);
                    label.textContent = `Overtone ${overtoneIndex} Strength`;
                    const slider = document.createElement('input');
                    slider.type = 'range';
                    slider.id = `overtone-${overtoneIndex}`;
                    slider.min = 0;
                    slider.max = 1.5;
                    slider.step = 0.01;
                    slider.value = ampValue;
                    slider.addEventListener('input', () => {
                        overtoneAmplitudes[partialIndex] = +slider.value;
                        if (dom.instrument.value !== 'custom') {
                            currentPartialFn = getPartialFunction(dom.instrument.value);
                            dom.instrument.value = 'custom';
                        }
                        generateAndPlot();
                        populateTables(); // Add this line to update the tables in real time
                    });
                    group.appendChild(label);
                    group.appendChild(slider);
                    dom.overtoneSlidersContainer.appendChild(group);
                }
            }
            function applyOvertonePreset(presetName) { const preset = overtonePresets[presetName]; if (!preset) return; overtoneAmplitudes = preset.slice(0, dom.overtones.value); const sliders = dom.overtoneSlidersContainer.querySelectorAll('input[type="range"]'); sliders.forEach((slider, index) => { if (overtoneAmplitudes[index] !== undefined) { slider.value = overtoneAmplitudes[index]; } }); dom.instrument.value = 'custom'; currentPartialFn = getPartialFunction('string'); generateAndPlot(); }
            function setupOvertonePresets() { dom.overtonePresetsContainer.innerHTML = ''; for (const presetName in overtonePresets) { const button = document.createElement('button'); button.textContent = presetName; button.className = 'preset-btn'; button.addEventListener('click', () => applyOvertonePreset(presetName)); dom.overtonePresetsContainer.appendChild(button); } }
            function resetOvertoneStrengths() { const sliders = dom.overtoneSlidersContainer.querySelectorAll('input[type="range"]'); const midPoint = 0.75; sliders.forEach((slider, index) => { slider.value = midPoint; overtoneAmplitudes[index] = midPoint; }); currentPartialFn = getPartialFunction(dom.instrument.value); dom.instrument.value = 'custom'; generateAndPlot(); }
            function resetToDefaults() { dom.baseFreq.value = 220; dom.overtones.value = 6; dom.octaves.value = 1; dom.equation.value = 'sethares'; dom.instrument.value = 'string'; dom.volume.value = 0.2; dom.tones.value = '3'; dom.chartType.value = 'surface'; dom.invertRoughness.checked = false; dom.tuningSystem.value = 'equal_12'; dom.bubbleSize.value = 25; updateTuningData(); updateOvertoneControls(true); populateTables(); generateAndPlot(); }
            function showMessage(text, duration = 3000) { dom.messageBox.textContent = text; dom.messageBox.style.display = 'block'; setTimeout(() => { dom.messageBox.style.display = 'none'; }, duration); }
            function populateTuningDropdown() { const select = dom.tuningSystem; select.innerHTML = ''; for (const groupName in TUNING_SYSTEMS) { const optgroup = document.createElement('optgroup'); optgroup.label = groupName; for (const key in TUNING_SYSTEMS[groupName]) { const option = document.createElement('option'); option.value = key; option.textContent = TUNING_SYSTEMS[groupName][key].name; optgroup.appendChild(option); } select.appendChild(optgroup); } select.value = 'equal_12'; }
            function setupEventListeners() { [dom.octaves, dom.equation, dom.volume, dom.tones, dom.chartType, dom.invertRoughness].forEach(el => { el.addEventListener('change', () => { updateTuningData(); populateTables(); generateAndPlot(); }); }); dom.bubbleSize.addEventListener('input', generateAndPlot); dom.instrument.addEventListener('change', () => { const settings = getSettings(); currentPartialFn = getPartialFunction(settings.instrument); updateOvertoneControls(true); updateTuningData(); populateTables(); generateAndPlot(); }); dom.overtones.addEventListener('change', () => { updateOvertoneControls(false); generateAndPlot(); populateTables(); }); dom.baseFreq.addEventListener('change', () => { generateAndPlot(); populateTables(); }); dom.tuningSystem.addEventListener('change', () => { updateTuningData(); populateTables(); generateAndPlot(); }); dom.resetBtn.addEventListener('click', resetToDefaults); dom.resetOvertonesBtn.addEventListener('click', resetOvertoneStrengths); dom.testOvertoneBtn.addEventListener('click', () => { const settings = getSettings(); playFrequencies([settings.baseFreq], 0.5); }); dom.themeToggle.addEventListener('change', () => { dom.body.dataset.theme = dom.themeToggle.checked ? 'dark' : 'light'; generateAndPlot(); }); new ResizeObserver(() => { Plotly.Plots.resize(dom.graph); }).observe(dom.graph); document.querySelectorAll('#dyads-table .sortable-header, #triads-table .sortable-header, #tetrads-table .sortable-header').forEach(header => {
  header.addEventListener('click', () => {
    const currentDir = header.dataset.sortDir;
    const newDir = currentDir === 'asc' ? 'desc' : 'asc';
    header.dataset.sortDir = newDir;
    populateTables();
  });
}); }
            
            if (typeof Plotly === 'undefined') {
                dom.graph.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">Error: Plotly library failed to load.</div>';
                return;
            }
            populateTuningDropdown();
            setupEventListeners();
            setupOvertonePresets();
            updateTuningData();
            updateOvertoneControls(true);
            generateAndPlot();
            populateTables();
        }
    </script>

    <!-- Physics Module Wiring (non-destructive) -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const homePage = document.getElementById('home-page');
        const musicPage = document.getElementById('music-page');
        const howItWorksPage = document.getElementById('how-it-works-page');
        const physicsPage = document.getElementById('physics-page');

        const physicsIconNav = document.getElementById('physics-icon-nav');
        const backFromPhysics = document.getElementById('back-from-physics');

        function switchPage(target) {
            const pages = [homePage, musicPage, howItWorksPage, physicsPage].filter(Boolean);
            pages.forEach(p => {
                p.classList.add('hidden');
                p.classList.remove('flex');
            });
            if (target) {
                target.classList.remove('hidden');
                target.classList.add('flex');
            }
            // If going back home, ensure it's visible even if it wasn't flex before
            if (target === homePage) {
                homePage.classList.remove('hidden');
            }
        }

        if (physicsIconNav) physicsIconNav.addEventListener('click', () => switchPage(physicsPage));
        if (backFromPhysics) backFromPhysics.addEventListener('click', () => switchPage(homePage));
    });
    </script>
</body>
</html>
